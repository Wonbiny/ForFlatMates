<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ForFlatMates â€” Duty Scheduler</title>
  <style>
    :root{
      --bg:#f7f7f5; --card:#fff; --text:#222; --muted:#666; --line:#e9e9e7;
      --btn:#111; --btnText:#fff; --btn2:#f0f0ee;
    }
    *{box-sizing:border-box}
    body{margin:0; padding:28px 14px; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,Arial; background:var(--bg); color:var(--text);}
    .wrap{max-width:1100px; margin:0 auto;}
    header{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:14px;}
    h1{margin:0; font-size:22px; font-weight:700; letter-spacing:-0.2px;}
    .subtitle{color:var(--muted); font-size:13px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,0.04); padding:14px; margin-bottom:14px;}
    .grid{display:grid; grid-template-columns:1.2fr 1fr; gap:12px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px;}
    input, select, button, textarea{
      width:100%; border:1px solid var(--line); border-radius:12px; padding:10px 12px;
      font-size:14px; background:#fff; color:var(--text);
    }
    textarea{min-height:52px; resize:vertical;}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
    @media (max-width:700px){ .row, .row3{grid-template-columns:1fr;} }
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    button{cursor:pointer}
    .primary{background:var(--btn); color:var(--btnText); border-color:var(--btn);}
    .secondary{background:var(--btn2);}
    .tiny{font-size:12px; padding:8px 10px; border-radius:10px; width:auto}
    .pill{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);}
    .pill input{width:auto}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{width:auto; padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; font-size:13px;}
    .tab.active{background:var(--btn); color:var(--btnText); border-color:var(--btn);}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--line);}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); text-align:center; font-size:13px;}
    th{background:#fbfbfa; color:#333; font-weight:650;}
    tr:hover td{background:#fafaf8}
    .muted{color:var(--muted); font-size:12px;}
    .right{display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap}

    /* Calendar */
    .cal-year{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .cal-year h2{margin:0; font-size:16px;}
    .months{display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;}
    @media (max-width:1000px){ .months{grid-template-columns:repeat(2, 1fr);} }
    @media (max-width:650px){ .months{grid-template-columns:1fr;} }
    .month{border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;}
    .month-head{padding:10px 12px; background:#fbfbfa; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center;}
    .month-title{font-weight:700; font-size:13px;}
    .dow{display:grid; grid-template-columns:repeat(7, 1fr); gap:0; padding:6px 8px; font-size:11px; color:var(--muted);}
    .days{display:grid; grid-template-columns:repeat(7, 1fr); gap:0; padding:0 8px 8px;}
    .cell{min-height:62px; border-radius:10px; padding:6px; margin:2px 0; border:1px solid transparent;}
    .cell.out{opacity:.35}
    .cell .d{font-size:11px; color:var(--muted); margin-bottom:4px;}
    .ev{font-size:11px; line-height:1.25; padding:6px; border-radius:10px; border:1px solid var(--line); background:#fcfcfb; text-align:left;}
    .ev b{font-weight:750}
    .ev .swapline{margin-top:6px; display:flex; justify-content:flex-end;}
    .ev button{width:auto; padding:6px 8px; border-radius:10px; border:1px solid var(--line); background:var(--btn2); font-size:11px;}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>ğŸ§¹ ForFlatMates</h1>
      <div class="subtitle">ì„¤ì • â†’ ìŠ¤ì¼€ì¤„ ìƒì„± â†’ ê³µìœ  URL / ìº˜ë¦°ë”(.ics)ë¡œ ë</div>
    </div>
    <div class="right">
      <button class="tiny secondary" id="copyLinkBtn">ë§í¬ ë³µì‚¬</button>
      <button class="tiny secondary" id="downloadIcsBtn">.ics ë‹¤ìš´ë¡œë“œ</button>
    </div>
  </header>

  <div class="card grid">
    <div>
      <label>ì‚¬ëŒë“¤ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
      <textarea id="peopleInput">Angel, Althea, Ahmed, Sofia, Bin</textarea>

      <label style="margin-top:10px;">ë“€í‹°/ì—­í•  (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: MOP,CLEAN / TRASH,BATHROOM ...)</label>
      <input id="rolesInput" value="MOP, CLEAN" />

      <div class="row" style="margin-top:10px;">
        <div>
          <label>ì‹œì‘ ë‚ ì§œ</label>
          <input type="date" id="startDate" />
        </div>
        <div>
          <label>ìƒì„± ê°œìˆ˜ (ëª‡ ë²ˆ ë°œìƒì‹œí‚¤ê¸°)</label>
          <input type="number" id="occurrences" min="1" value="30" />
        </div>
      </div>

      <div class="row3" style="margin-top:10px;">
        <div>
          <label>ê°„ê²©</label>
          <input type="number" id="intervalValue" min="1" value="1" />
        </div>
        <div>
          <label>ë‹¨ìœ„</label>
          <select id="intervalUnit">
            <option value="days">nì¼ì— í•œ ë²ˆ</option>
            <option value="weeks" selected>nì£¼ì— í•œ ë²ˆ</option>
            <option value="months">në‹¬ì— í•œ ë²ˆ</option>
          </select>
        </div>
        <div>
          <label>í•œ ë²ˆì— ë½‘ì„ ì¸ì›</label>
          <input type="number" id="peoplePerDuty" min="1" value="2" />
        </div>
      </div>

      <div class="btns">
        <label class="pill"><input type="checkbox" id="noConsecutive" checked />ì—°ì†(ë°”ë¡œ ë‹¤ìŒ íšŒì°¨) ë‹¹ë²ˆ ê¸ˆì§€</label>
        <label class="pill"><input type="checkbox" id="show2026" checked />2026 ìº˜ë¦°ë” ë·° í‘œì‹œ</label>
      </div>

      <div class="btns">
        <button class="primary" id="generateBtn">ìŠ¤ì¼€ì¤„ ìƒì„±</button>
        <button class="secondary" id="resetBtn">ì´ˆê¸°í™”</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        * â€œì—°ì† ê¸ˆì§€â€ëŠ” ê°™ì€ ì‚¬ëŒì´ <b>ë°”ë¡œ ë‹¤ìŒ íšŒì°¨</b>ì— ë˜ ê±¸ë¦¬ëŠ” ê±¸ ë§‰ì•„ì¤˜.<br/>
        * ìº˜ë¦°ë”(.ics)ëŠ” Google Calendarì—ì„œ â€œê°€ì ¸ì˜¤ê¸°â€ë¡œ ë„£ìœ¼ë©´ ë¼.
      </div>
    </div>

    <div>
      <div class="tabs">
        <button class="tab active" id="tabTable">í‘œ</button>
        <button class="tab" id="tabCalendar">2026 ìº˜ë¦°ë”</button>
      </div>

      <div id="viewTable" style="margin-top:10px;">
        <div class="muted">ê° í–‰ì—ì„œ Swapì„ ëˆ„ë¥´ë©´ ê·¸ íšŒì°¨ ì—­í• ì´ ì„œë¡œ ë°”ë€Œê³ , ë³€ê²½ì´ ë§í¬ì— ì €ì¥ë¼.</div>
        <div style="margin-top:10px; overflow:auto;">
          <table id="scheduleTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="viewCalendar" style="margin-top:10px; display:none;">
        <div class="muted">2026ë…„ ë‹¬ë ¥ì— ì´ë²¤íŠ¸ê°€ ë°•í˜€ì„œ ë³´ì—¬. (í‘œì‹œì¼ = ê° íšŒì°¨ ë‚ ì§œ)</div>
        <div id="calendar2026" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
/** ---------------------------
 * State + URL share
 * --------------------------*/
const DEFAULT_STATE = () => ({
  people: ["Angel","Althea","Ahmed","Sofia","Bin"],
  roles: ["MOP","CLEAN"],
  startDate: null,                 // "YYYY-MM-DD"
  occurrences: 30,
  intervalValue: 1,
  intervalUnit: "weeks",           // "days" | "weeks" | "months"
  peoplePerDuty: 2,
  noConsecutive: true,
  show2026: true,
  // schedule items: { idx, date:"YYYY-MM-DD", assigned:["A","B",...], swapped:false }
  schedule: []
});

let state = DEFAULT_STATE();

function encodeState(obj){
  const json = JSON.stringify(obj);
  // URL-safe base64
  return btoa(unescape(encodeURIComponent(json))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function decodeState(s){
  const pad = '='.repeat((4 - (s.length % 4)) % 4);
  const b64 = (s + pad).replace(/-/g,'+').replace(/_/g,'/');
  const json = decodeURIComponent(escape(atob(b64)));
  return JSON.parse(json);
}
function syncToURL(){
  const data = encodeState(state);
  const url = new URL(window.location.href);
  url.searchParams.set("data", data);
  history.replaceState(null, "", url.toString());
}
function loadFromURL(){
  const url = new URL(window.location.href);
  const data = url.searchParams.get("data");
  if (!data) return false;
  try {
    state = decodeState(data);
    return true;
  } catch {
    return false;
  }
}

/** ---------------------------
 * Date helpers
 * --------------------------*/
function isoTodayLocal(){
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function parseISO(iso){
  // local midnight
  const [y,m,dd] = iso.split("-").map(Number);
  return new Date(y, m-1, dd, 0,0,0,0);
}
function toISO(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function addInterval(date, value, unit){
  const d = new Date(date);
  if (unit === "days") d.setDate(d.getDate() + value);
  else if (unit === "weeks") d.setDate(d.getDate() + value*7);
  else if (unit === "months") d.setMonth(d.getMonth() + value);
  return d;
}

/** ---------------------------
 * Scheduler
 * - fair-ish: least assignments first
 * - noConsecutive: exclude previous occurrence assignees
 * --------------------------*/
function generateSchedule(){
  const people = state.people.slice();
  const roles = state.roles.slice();
  const per = Math.max(1, Math.min(state.peoplePerDuty, roles.length, people.length));
  const start = parseISO(state.startDate);
  const counts = Object.fromEntries(people.map(p => [p, 0]));

  let lastAssigned = new Set();
  const schedule = [];

  for (let i=0; i<state.occurrences; i++){
    const date = addInterval(start, i*state.intervalValue, state.intervalUnit);

    // candidates
    let candidates = people.slice();
    if (state.noConsecutive) candidates = candidates.filter(p => !lastAssigned.has(p));
    // if too strict (e.g. very small people), fallback to full list
    if (candidates.length < per) candidates = people.slice();

    // sort by least count then stable by name
    candidates.sort((a,b) => (counts[a]-counts[b]) || a.localeCompare(b));

    const chosen = candidates.slice(0, per);
    chosen.forEach(p => counts[p]++);

    schedule.push({
      idx: i,
      date: toISO(date),
      assigned: chosen.concat(Array(Math.max(0, roles.length - chosen.length)).fill("-")),
    });

    lastAssigned = new Set(chosen);
  }

  state.schedule = schedule;
}

/** ---------------------------
 * UI render
 * --------------------------*/
const els = {
  peopleInput: document.getElementById("peopleInput"),
  rolesInput: document.getElementById("rolesInput"),
  startDate: document.getElementById("startDate"),
  occurrences: document.getElementById("occurrences"),
  intervalValue: document.getElementById("intervalValue"),
  intervalUnit: document.getElementById("intervalUnit"),
  peoplePerDuty: document.getElementById("peoplePerDuty"),
  noConsecutive: document.getElementById("noConsecutive"),
  show2026: document.getElementById("show2026"),
  generateBtn: document.getElementById("generateBtn"),
  resetBtn: document.getElementById("resetBtn"),
  copyLinkBtn: document.getElementById("copyLinkBtn"),
  downloadIcsBtn: document.getElementById("downloadIcsBtn"),

  tabTable: document.getElementById("tabTable"),
  tabCalendar: document.getElementById("tabCalendar"),
  viewTable: document.getElementById("viewTable"),
  viewCalendar: document.getElementById("viewCalendar"),

  table: document.getElementById("scheduleTable"),
  calWrap: document.getElementById("calendar2026"),
};

function hydrateForm(){
  els.peopleInput.value = state.people.join(", ");
  els.rolesInput.value = state.roles.join(", ");
  els.startDate.value = state.startDate || isoTodayLocal();
  els.occurrences.value = state.occurrences;
  els.intervalValue.value = state.intervalValue;
  els.intervalUnit.value = state.intervalUnit;
  els.peoplePerDuty.value = state.peoplePerDuty;
  els.noConsecutive.checked = !!state.noConsecutive;
  els.show2026.checked = !!state.show2026;
}

function readForm(){
  const people = els.peopleInput.value.split(",").map(s=>s.trim()).filter(Boolean);
  const roles = els.rolesInput.value.split(",").map(s=>s.trim()).filter(Boolean);
  if (people.length < 1) return alert("ì‚¬ëŒì„ 1ëª… ì´ìƒ ì…ë ¥í•´ì¤˜!");
  if (roles.length < 1) return alert("ë“€í‹°/ì—­í• ì„ 1ê°œ ì´ìƒ ì…ë ¥í•´ì¤˜!");

  state.people = people;
  state.roles = roles;
  state.startDate = els.startDate.value || isoTodayLocal();
  state.occurrences = Math.max(1, parseInt(els.occurrences.value || "1", 10));
  state.intervalValue = Math.max(1, parseInt(els.intervalValue.value || "1", 10));
  state.intervalUnit = els.intervalUnit.value;
  state.peoplePerDuty = Math.max(1, parseInt(els.peoplePerDuty.value || "1", 10));
  state.noConsecutive = els.noConsecutive.checked;
  state.show2026 = els.show2026.checked;
}

function renderTable(){
  const roles = state.roles;
  const thead = els.table.querySelector("thead");
  const tbody = els.table.querySelector("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  const h = document.createElement("tr");
  h.innerHTML = `<th>#</th><th>ë‚ ì§œ</th>` + roles.map(r=>`<th>${escapeHtml(r)}</th>`).join("") + `<th>Swap</th>`;
  thead.appendChild(h);

  state.schedule.forEach(item => {
    const tr = document.createElement("tr");
    const cells = item.assigned.slice(0, roles.length);
    tr.innerHTML =
      `<td>${item.idx + 1}</td>` +
      `<td>${item.date}</td>` +
      cells.map(p=>`<td>${escapeHtml(p)}</td>`).join("") +
      `<td><button class="tiny secondary" data-swap="${item.idx}">Swap</button></td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button[data-swap]").forEach(btn=>{
    btn.addEventListener("click", () => {
      const idx = parseInt(btn.getAttribute("data-swap"), 10);
      swapRolesAt(idx);
    });
  });
}

function swapRolesAt(idx){
  const rolesLen = state.roles.length;
  const item = state.schedule.find(x => x.idx === idx);
  if (!item) return;
  if (rolesLen < 2) return;

  // swap first two roles (MOP<->CLEAN ê°™ì€ ì¼€ì´ìŠ¤)
  const a0 = item.assigned[0];
  const a1 = item.assigned[1];
  item.assigned[0] = a1;
  item.assigned[1] = a0;

  syncToURL();
  renderTable();
  if (state.show2026) renderCalendar2026();
}

/** ---------------------------
 * 2026 Calendar (month grid)
 * - mark events that fall in 2026
 * --------------------------*/
const DOW = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

function renderCalendar2026(){
  els.calWrap.innerHTML = "";

  const eventsMap = new Map(); // "YYYY-MM-DD" -> item
  state.schedule.forEach(it => {
    if (it.date.startsWith("2026-")) eventsMap.set(it.date, it);
  });

  const container = document.createElement("div");
  container.className = "months";

  for (let month=0; month<12; month++){
    const monthBox = document.createElement("div");
    monthBox.className = "month";

    const head = document.createElement("div");
    head.className = "month-head";
    head.innerHTML = `<div class="month-title">2026ë…„ ${month+1}ì›”</div><div class="muted">${DOW.join(" ")}</div>`;
    monthBox.appendChild(head);

    const dow = document.createElement("div");
    dow.className = "dow";
    DOW.forEach(d => {
      const s = document.createElement("div");
      s.textContent = d;
      dow.appendChild(s);
    });
    monthBox.appendChild(dow);

    const days = document.createElement("div");
    days.className = "days";

    const first = new Date(2026, month, 1);
    const firstDow = first.getDay(); // 0=Sun
    const start = new Date(2026, month, 1 - firstDow); // start from Sunday of first week grid

    for (let i=0; i<42; i++){
      const d = new Date(start);
      d.setDate(start.getDate() + i);

      const iso = toISO(d);
      const cell = document.createElement("div");
      cell.className = "cell" + (d.getMonth() !== month ? " out" : "");

      const top = document.createElement("div");
      top.className = "d";
      top.textContent = String(d.getDate());
      cell.appendChild(top);

      const it = eventsMap.get(iso);
      if (it && d.getMonth() === month){
        const ev = document.createElement("div");
        ev.className = "ev";
        const rolesLen = state.roles.length;
        const lines = [];
        for (let r=0; r<rolesLen; r++){
          lines.push(`<b>${escapeHtml(state.roles[r])}</b>: ${escapeHtml(it.assigned[r] ?? "-")}`);
        }
        ev.innerHTML = lines.join("<br/>") + `<div class="swapline"><button data-swapcal="${it.idx}">Swap</button></div>`;
        cell.appendChild(ev);
      }

      days.appendChild(cell);
    }

    monthBox.appendChild(days);
    container.appendChild(monthBox);
  }

  els.calWrap.appendChild(container);

  els.calWrap.querySelectorAll("button[data-swapcal]").forEach(btn=>{
    btn.addEventListener("click", () => {
      const idx = parseInt(btn.getAttribute("data-swapcal"), 10);
      swapRolesAt(idx);
    });
  });
}

/** ---------------------------
 * Tabs
 * --------------------------*/
function setTab(which){
  const isTable = which === "table";
  els.tabTable.classList.toggle("active", isTable);
  els.tabCalendar.classList.toggle("active", !isTable);
  els.viewTable.style.display = isTable ? "" : "none";
  els.viewCalendar.style.display = isTable ? "none" : "";
}

/** ---------------------------
 * ICS export
 * - all-day event on the occurrence date
 * --------------------------*/
function formatICSDate(iso){
  // YYYYMMDD
  return iso.replaceAll("-", "");
}
function downloadICS(){
  if (!state.schedule.length) return alert("ë¨¼ì € ìŠ¤ì¼€ì¤„ì„ ìƒì„±í•´ì¤˜!");

  const lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//ForFlatMates//Duty Scheduler//KO");

  state.schedule.forEach(it => {
    const dt = formatICSDate(it.date);
    const uid = `forflatmates-${dt}-${it.idx}@local`;
    const rolesLen = state.roles.length;

    let desc = "";
    for (let r=0; r<rolesLen; r++){
      desc += `${state.roles[r]}: ${it.assigned[r] ?? "-"}\\n`;
    }
    desc += `\\nGenerated by ForFlatMates`;

    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${uid}`);
    lines.push(`DTSTART;VALUE=DATE:${dt}`);
    // DTEND is next day for all-day; required by many clients
    const next = toISO(addInterval(parseISO(it.date), 1, "days"));
    lines.push(`DTEND;VALUE=DATE:${formatICSDate(next)}`);
    lines.push(`SUMMARY:ğŸ§¹ Duty`);
    lines.push(`DESCRIPTION:${escapeICSText(desc)}`);
    lines.push("END:VEVENT");
  });

  lines.push("END:VCALENDAR");

  const blob = new Blob([lines.join("\n")], {type:"text/calendar;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "forflatmates_duty.ics";
  a.click();
}

/** ---------------------------
 * Utilities
 * --------------------------*/
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function escapeICSText(s){
  // basic ICS escaping
  return String(s).replace(/\\/g, "\\\\").replace(/\n/g, "\\n").replace(/,/g, "\\,").replace(/;/g, "\\;");
}

/** ---------------------------
 * Wire up
 * --------------------------*/
function applyStateToUIAndRender(){
  hydrateForm();
  if (!state.startDate) state.startDate = isoTodayLocal();
  if (!state.schedule?.length){
    generateSchedule();
  }
  renderTable();
  if (state.show2026) renderCalendar2026();
  syncToURL();
}

els.generateBtn.addEventListener("click", () => {
  readForm();
  generateSchedule();
  renderTable();
  if (state.show2026) renderCalendar2026();
  syncToURL();
});

els.resetBtn.addEventListener("click", () => {
  state = DEFAULT_STATE();
  state.startDate = isoTodayLocal();
  generateSchedule();
  applyStateToUIAndRender();
});

els.copyLinkBtn.addEventListener("click", async () => {
  syncToURL();
  try {
    await navigator.clipboard.writeText(window.location.href);
    alert("ê³µìœ  ë§í¬ ë³µì‚¬ ì™„ë£Œ!");
  } catch {
    prompt("ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•´ì¤˜:", window.location.href);
  }
});

els.downloadIcsBtn.addEventListener("click", downloadICS);

els.tabTable.addEventListener("click", () => setTab("table"));
els.tabCalendar.addEventListener("click", () => setTab("calendar"));

els.show2026.addEventListener("change", () => {
  state.show2026 = els.show2026.checked;
  syncToURL();
  if (state.show2026) renderCalendar2026();
});

(function init(){
  const loaded = loadFromURL();
  if (!loaded){
    state.startDate = isoTodayLocal();
    generateSchedule();
    syncToURL();
  }
  applyStateToUIAndRender();
})();
</script>
</body>
</html>
